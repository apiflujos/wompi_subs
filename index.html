<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Suscripciones Wompi</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, sans-serif; }
    .animate-spin { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    // ⚠️ CONFIGURACIÓN - Actualiza con tu URL de n8n
    const N8N_BASE_URL = 'https://automan.apiflujos.com/webhook';
    
    // Iconos SVG simplificados
    const Icon = {
      Search: ({ size = 20, className = '' }) => (
        <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
        </svg>
      ),
      Plus: ({ size = 20 }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
      ),
      X: ({ size = 20 }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      ),
      Pause: ({ size = 20 }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>
        </svg>
      ),
      Play: ({ size = 20 }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <polygon points="5 3 19 12 5 21 5 3"/>
        </svg>
      ),
      RefreshCw: ({ size = 20, className = '' }) => (
        <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/>
          <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
        </svg>
      ),
      AlertCircle: ({ size = 20, className = '' }) => (
        <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
      ),
      CheckCircle: ({ size = 20, className = '' }) => (
        <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
      ),
      Users: ({ size = 20, className = '' }) => (
        <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
        </svg>
      ),
      DollarSign: ({ size = 20, className = '' }) => (
        <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
        </svg>
      ),
      Calendar: ({ size = 20, className = '' }) => (
        <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/>
          <line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
        </svg>
      ),
      ExternalLink: ({ size = 20 }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/>
          <line x1="10" y1="14" x2="21" y2="3"/>
        </svg>
      ),
      Loader: ({ size = 32, className = '' }) => (
        <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/>
          <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/>
          <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/>
        </svg>
      )
    };

    const SubscriptionDashboard = () => {
      const API_ENDPOINTS = {
        CREATE: `${N8N_BASE_URL}/wompi/create-subscription`,
        LIST: `${N8N_BASE_URL}/wompi/list-subscriptions`,
        UPDATE_STATUS: `${N8N_BASE_URL}/wompi/update-subscription`,
      };

      const [subscriptions, setSubscriptions] = useState([]);
      const [filteredSubs, setFilteredSubs] = useState([]);
      const [searchTerm, setSearchTerm] = useState('');
      const [statusFilter, setStatusFilter] = useState('all');
      const [showModal, setShowModal] = useState(false);
      const [modalType, setModalType] = useState('');
      const [selectedSub, setSelectedSub] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [success, setSuccess] = useState(null);
      
      const [newSub, setNewSub] = useState({
        customer_name: '',
        customer_email: '',
        customer_phone: '+57',
        customer_document_type: 'CC',
        customer_document: '',
        plan_id: 'basic_monthly',
        payment_method: 'manual'
      });

      const plans = {
        'basic_monthly': { name: 'Básico Mensual', amount: 30000, cycle: 'monthly' },
        'premium_monthly': { name: 'Premium Mensual', amount: 50000, cycle: 'monthly' },
        'premium_yearly': { name: 'Premium Anual', amount: 500000, cycle: 'yearly' }
      };

      const statusMap = {
        'pending_first_payment': { label: 'Pendiente Primer Pago', color: 'yellow' },
        'active': { label: 'Activa', color: 'green' },
        'suspended': { label: 'Suspendida', color: 'orange' },
        'cancelled': { label: 'Cancelada', color: 'red' },
        'payment_failed': { label: 'Pago Fallido', color: 'red' }
      };

      useEffect(() => {
        fetchSubscriptions();
        const interval = setInterval(fetchSubscriptions, 30000);
        return () => clearInterval(interval);
      }, []);

      useEffect(() => {
        let filtered = subscriptions;
        
        if (searchTerm) {
          filtered = filtered.filter(sub => 
            sub.customer_name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
            sub.customer_email?.toLowerCase().includes(searchTerm.toLowerCase()) ||
            sub.subscription_id?.toLowerCase().includes(searchTerm.toLowerCase())
          );
        }
        
        if (statusFilter !== 'all') {
          filtered = filtered.filter(sub => sub.status === statusFilter);
        }
        
        setFilteredSubs(filtered);
      }, [searchTerm, statusFilter, subscriptions]);

      const fetchSubscriptions = async () => {
        setLoading(true);
        setError(null);
        
        try {
          const response = await fetch(API_ENDPOINTS.LIST, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
          });
          
          if (!response.ok) throw new Error('Error al cargar suscripciones');
          
          const data = await response.json();
          setSubscriptions(data.subscriptions || data || []);
        } catch (err) {
          setError('No se pudieron cargar las suscripciones. Verifica la conexión con n8n.');
          console.error('Error:', err);
          
          // Datos de ejemplo para testing
          setSubscriptions([
            { 
              subscription_id: 'sub_demo_001',
              customer_name: 'Juan Pérez', 
              customer_email: 'juan@email.com',
              customer_phone: '+573001234567',
              plan_id: 'premium_monthly',
              plan_name: 'Premium Mensual', 
              amount: 50000,
              status: 'active',
              billing_cycle: 'monthly',
              payment_method: 'auto',
              created_at: '2024-12-01T00:00:00Z',
              next_billing_date: '2025-02-01T00:00:00Z',
              failed_payments_count: 0
            }
          ]);
        } finally {
          setLoading(false);
        }
      };

      const handleCreateSubscription = async () => {
        if (!newSub.customer_name || !newSub.customer_email || !newSub.customer_phone) {
          setError('Por favor completa todos los campos requeridos');
          return;
        }

        if (!/^\+57\d{10}$/.test(newSub.customer_phone)) {
          setError('El teléfono debe tener formato +57XXXXXXXXXX (10 dígitos)');
          return;
        }

        setLoading(true);
        setError(null);
        
        try {
          const response = await fetch(API_ENDPOINTS.CREATE, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newSub)
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Error al crear suscripción');
          }
          
          setSuccess('¡Suscripción creada exitosamente! Link enviado por WhatsApp.');
          await fetchSubscriptions();
          closeModal();
        } catch (err) {
          setError(err.message || 'Error al crear la suscripción.');
        } finally {
          setLoading(false);
        }
      };

      const updateSubscriptionStatus = async (action) => {
        setLoading(true);
        setError(null);
        
        try {
          const response = await fetch(API_ENDPOINTS.UPDATE_STATUS, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              subscription_id: selectedSub.subscription_id,
              action: action,
              customer_email: selectedSub.customer_email
            })
          });
          
          if (!response.ok) throw new Error('Error al actualizar');
          
          const actionText = action === 'suspend' ? 'suspendida' : action === 'reactivate' ? 'reactivada' : 'cancelada';
          setSuccess(`¡Suscripción ${actionText} exitosamente!`);
          await fetchSubscriptions();
          closeModal();
        } catch (err) {
          setError('Error al actualizar la suscripción.');
        } finally {
          setLoading(false);
        }
      };

      const metrics = {
        active: subscriptions.filter(s => s.status === 'active').length,
        suspended: subscriptions.filter(s => s.status === 'suspended').length,
        pending: subscriptions.filter(s => s.status === 'pending_first_payment').length,
        mrr: subscriptions.filter(s => s.status === 'active').reduce((sum, s) => sum + (s.amount || 0), 0),
        total: subscriptions.length
      };

      const openModal = (type, sub = null) => {
        setModalType(type);
        setSelectedSub(sub);
        setShowModal(true);
        setError(null);
        setSuccess(null);
      };

      const closeModal = () => {
        setShowModal(false);
        setSelectedSub(null);
        setNewSub({
          customer_name: '',
          customer_email: '',
          customer_phone: '+57',
          customer_document_type: 'CC',
          customer_document: '',
          plan_id: 'basic_monthly',
          payment_method: 'manual'
        });
        setError(null);
        setSuccess(null);
      };

      const formatCurrency = (amount) => {
        return new Intl.NumberFormat('es-CO', {
          style: 'currency',
          currency: 'COP',
          minimumFractionDigits: 0
        }).format(amount);
      };

      const formatDate = (dateString) => {
        if (!dateString) return 'N/A';
        return new Date(dateString).toLocaleDateString('es-CO', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      };

      const getStatusBadge = (status) => {
        const statusInfo = statusMap[status] || { label: status, color: 'gray' };
        const colors = {
          green: 'bg-green-100 text-green-800 border-green-200',
          yellow: 'bg-yellow-100 text-yellow-800 border-yellow-200',
          orange: 'bg-orange-100 text-orange-800 border-orange-200',
          red: 'bg-red-100 text-red-800 border-red-200',
          gray: 'bg-gray-100 text-gray-800 border-gray-200'
        };
        
        return (
          <span className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium border ${colors[statusInfo.color]}`}>
            {statusInfo.label}
          </span>
        );
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-6">
          <div className="max-w-7xl mx-auto">
            {/* Header */}
            <div className="mb-8">
              <div className="flex items-center justify-between">
                <div>
                  <h1 className="text-4xl font-bold text-slate-900 mb-2">Gestión de Suscripciones Wompi</h1>
                  <p className="text-slate-600">Panel integrado con n8n</p>
                </div>
                <button 
                  onClick={fetchSubscriptions}
                  disabled={loading}
                  className="p-3 bg-white rounded-lg shadow-sm border hover:bg-slate-50"
                >
                  <Icon.RefreshCw size={20} className={`text-slate-600 ${loading ? 'animate-spin' : ''}`} />
                </button>
              </div>
            </div>

            {/* Alerts */}
            {error && (
              <div className="mb-6 bg-red-50 border border-red-200 rounded-lg p-4 flex items-start gap-3">
                <Icon.AlertCircle className="text-red-600 flex-shrink-0 mt-0.5" size={20} />
                <div className="flex-1">
                  <p className="text-red-800 font-medium">Error</p>
                  <p className="text-red-700 text-sm">{error}</p>
                </div>
                <button onClick={() => setError(null)} className="text-red-600">
                  <Icon.X size={18} />
                </button>
              </div>
            )}

            {success && (
              <div className="mb-6 bg-green-50 border border-green-200 rounded-lg p-4 flex items-start gap-3">
                <Icon.CheckCircle className="text-green-600 flex-shrink-0 mt-0.5" size={20} />
                <div className="flex-1">
                  <p className="text-green-800 font-medium">Éxito</p>
                  <p className="text-green-700 text-sm">{success}</p>
                </div>
                <button onClick={() => setSuccess(null)} className="text-green-600">
                  <Icon.X size={18} />
                </button>
              </div>
            )}

            {/* Metrics */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
              <div className="bg-white rounded-xl shadow-sm p-6 border">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm font-medium text-slate-600">Activas</span>
                  <Icon.Users className="text-green-500" size={20} />
                </div>
                <div className="text-3xl font-bold">{metrics.active}</div>
              </div>

              <div className="bg-white rounded-xl shadow-sm p-6 border">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm font-medium text-slate-600">Pendientes</span>
                  <Icon.AlertCircle className="text-yellow-500" size={20} />
                </div>
                <div className="text-3xl font-bold">{metrics.pending}</div>
              </div>

              <div className="bg-white rounded-xl shadow-sm p-6 border">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm font-medium text-slate-600">MRR</span>
                  <Icon.DollarSign className="text-blue-500" size={20} />
                </div>
                <div className="text-2xl font-bold">{formatCurrency(metrics.mrr)}</div>
              </div>

              <div className="bg-white rounded-xl shadow-sm p-6 border">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm font-medium text-slate-600">Total</span>
                  <Icon.CheckCircle className="text-purple-500" size={20} />
                </div>
                <div className="text-3xl font-bold">{metrics.total}</div>
              </div>
            </div>

            {/* Filters */}
            <div className="bg-white rounded-xl shadow-sm border p-6 mb-6">
              <div className="flex flex-col md:flex-row gap-4">
                <div className="flex-1 relative">
                  <Icon.Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400" size={20} />
                  <input
                    type="text"
                    placeholder="Buscar por cliente, email o ID..."
                    className="w-full pl-10 pr-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                  />
                </div>
                
                <select 
                  className="px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                  value={statusFilter}
                  onChange={(e) => setStatusFilter(e.target.value)}
                >
                  <option value="all">Todos</option>
                  <option value="active">Activas</option>
                  <option value="pending_first_payment">Pendientes</option>
                  <option value="suspended">Suspendidas</option>
                  <option value="cancelled">Canceladas</option>
                </select>
                
                <button 
                  onClick={() => openModal('create')}
                  className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 whitespace-nowrap"
                >
                  <Icon.Plus size={20} />
                  Nueva Suscripción
                </button>
              </div>
            </div>

            {/* Table */}
            <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
              {loading && subscriptions.length === 0 ? (
                <div className="flex items-center justify-center py-12">
                  <Icon.Loader className="animate-spin text-blue-600" size={32} />
                </div>
              ) : filteredSubs.length === 0 ? (
                <div className="text-center py-12 text-slate-500">
                  No se encontraron suscripciones
                </div>
              ) : (
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-slate-50 border-b">
                      <tr>
                        <th className="px-6 py-4 text-left text-sm font-semibold text-slate-700">Cliente</th>
                        <th className="px-6 py-4 text-left text-sm font-semibold text-slate-700">Plan</th>
                        <th className="px-6 py-4 text-left text-sm font-semibold text-slate-700">Valor</th>
                        <th className="px-6 py-4 text-left text-sm font-semibold text-slate-700">Estado</th>
                        <th className="px-6 py-4 text-left text-sm font-semibold text-slate-700">Próximo Cobro</th>
                        <th className="px-6 py-4 text-center text-sm font-semibold text-slate-700">Acciones</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y">
                      {filteredSubs.map((sub) => (
                        <tr key={sub.subscription_id} className="hover:bg-slate-50">
                          <td className="px-6 py-4">
                            <div className="font-medium text-slate-900">{sub.customer_name}</div>
                            <div className="text-sm text-slate-500">{sub.customer_email}</div>
                            <div className="text-xs text-slate-400 font-mono">{sub.subscription_id}</div>
                          </td>
                          <td className="px-6 py-4">
                            <span className="inline-flex px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                              {sub.plan_name || plans[sub.plan_id]?.name}
                            </span>
                          </td>
                          <td className="px-6 py-4 font-medium">{formatCurrency(sub.amount)}</td>
                          <td className="px-6 py-4">{getStatusBadge(sub.status)}</td>
                          <td className="px-6 py-4">
                            {sub.next_billing_date ? (
                              <div className="flex items-center gap-2 text-slate-600">
                                <Icon.Calendar size={16} className="text-slate-400" />
                                {formatDate(sub.next_billing_date)}
                              </div>
                            ) : (
                              <span className="text-slate-400">N/A</span>
                            )}
                            {sub.current_payment_link && (
                              <a 
                                href={sub.current_payment_link}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 mt-1"
                              >
                                Ver link <Icon.ExternalLink size={12} />
                              </a>
                            )}
                          </td>
                          <td className="px-6 py-4">
                            <div className="flex items-center justify-center gap-2">
                              {sub.status === 'active' && (
                                <>
                                  <button 
                                    onClick={() => openModal('suspend', sub)}
                                    className="p-2 text-yellow-600 hover:bg-yellow-50 rounded-lg"
                                    title="Suspender"
                                  >
                                    <Icon.Pause size={18} />
                                  </button>
                                  <button 
                                    onClick={() => openModal('cancel', sub)}
                                    className="p-2 text-red-600 hover:bg-red-50 rounded-lg"
                                    title="Cancelar"
                                  >
                                    <Icon.X size={18} />
                                  </button>
                                </>
                              )}
                              {(sub.status === 'suspended' || sub.status === 'payment_failed') && (
                                <>
                                  <button 
                                    onClick={() => openModal('reactivate', sub)}
                                    className="p-2 text-green-600 hover:bg-green-50 rounded-lg"
                                    title="Reactivar"
                                  >
                                    <Icon.Play size={18} />
                                  </button>
                                  <button 
                                    onClick={() => openModal('cancel', sub)}
                                    className="p-2 text-red-600 hover:bg-red-50 rounded-lg"
                                    title="Cancelar"
                                  >
                                    <Icon.X size={18} />
                                  </button>
                                </>
                              )}
                              {sub.status === 'cancelled' && (
                                <span className="text-sm text-slate-400">Sin acciones</span>
                              )}
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>

            {/* Modal */}
            {showModal && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl shadow-xl max-w-md w-full p-6 max-h-[90vh] overflow-y-auto">
                  {modalType === 'create' && (
                    <>
                      <h2 className="text-2xl font-bold text-slate-900 mb-4">Nueva Suscripción</h2>
                      <div className="space-y-4">
                        <div>
                          <label className="block text-sm font-medium text-slate-700 mb-2">Nombre *</label>
                          <input
                            type="text"
                            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                            value={newSub.customer_name}
                            onChange={(e) => setNewSub({...newSub, customer_name: e.target.value})}
                            placeholder="Juan Pérez"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-slate-700 mb-2">Email *</label>
                          <input
                            type="email"
                            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                            value={newSub.customer_email}
                            onChange={(e) => setNewSub({...newSub, customer_email: e.target.value})}
                            placeholder="email@ejemplo.com"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-slate-700 mb-2">Teléfono (Colombia) *</label>
                          <input
                            type="tel"
                            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                            value={newSub.customer_phone}
                            onChange={(e) => setNewSub({...newSub, customer_phone: e.target.value})}
                            placeholder="+573001234567"
                          />
                          <p className="text-xs text-slate-500 mt-1">Formato: +57 + 10 dígitos</p>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-slate-700 mb-2">Plan *</label>
                          <select
                            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                            value={newSub.plan_id}
                            onChange={(e) => setNewSub({...newSub, plan_id: e.target.value})}
                          >
                            {Object.entries(plans).map(([id, plan]) => (
                              <option key={id} value={id}>
                                {plan.name} - {formatCurrency(plan.amount)}
                              </option>
                            ))}
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-slate-700 mb-2">Método de Pago *</label>
                          <select
                            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                            value={newSub.payment_method}
                            onChange={(e) => setNewSub({...newSub, payment_method: e.target.value})}
                          >
                            <option value="manual">Manual (Link de pago)</option>
                            <option value="auto">Automático (Tarjeta guardada)</option>
                          </select>
                        </div>
                      </div>
                      <div className="flex gap-3 mt-6">
                        <button
                          onClick={closeModal}
                          className="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50"
                          disabled={loading}
                        >
                          Cancelar
                        </button>
                        <button
                          onClick={handleCreateSubscription}
                          className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
                          disabled={loading || !newSub.customer_name || !newSub.customer_email}
                        >
                          {loading ? 'Creando...' : 'Crear Suscripción'}
                        </button>
                      </div>
                    </>
                  )}

                  {modalType === 'suspend' && selectedSub && (
                    <>
                      <h2 className="text-2xl font-bold text-slate-900 mb-4">Suspender Suscripción</h2>
                      <p className="text-slate-600 mb-6">
                        ¿Suspender temporalmente la suscripción de <strong>{selectedSub.customer_name}</strong>? 
                        No se cobrará hasta reactivarla.
                      </p>
                      <div className="flex gap-3">
                        <button
                          onClick={closeModal}
                          className="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50"
                          disabled={loading}
                        >
                          Cancelar
                        </button>
                        <button
                          onClick={() => updateSubscriptionStatus('suspend')}
                          className="flex-1 px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700"
                          disabled={loading}
                        >
                          {loading ? 'Suspendiendo...' : 'Suspender'}
                        </button>
                      </div>
                    </>
                  )}

                  {modalType === 'reactivate' && selectedSub && (
                    <>
                      <h2 className="text-2xl font-bold text-slate-900 mb-4">Reactivar Suscripción</h2>
                      <p className="text-slate-600 mb-6">
                        ¿Reactivar la suscripción de <strong>{selectedSub.customer_name}</strong>? 
                        Se reanudará el ciclo de facturación.
                      </p>
                      <div className="flex gap-3">
                        <button
                          onClick={closeModal}
                          className="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50"
                          disabled={loading}
                        >
                          Cancelar
                        </button>
                        <button
                          onClick={() => updateSubscriptionStatus('reactivate')}
                          className="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                          disabled={loading}
                        >
                          {loading ? 'Reactivando...' : 'Reactivar'}
                        </button>
                      </div>
                    </>
                  )}

                  {modalType === 'cancel' && selectedSub && (
                    <>
                      <h2 className="text-2xl font-bold text-slate-900 mb-4">Cancelar Suscripción</h2>
                      <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                        <p className="text-red-800 text-sm">
                          <strong>⚠️ Advertencia:</strong> Esta acción es permanente.
                        </p>
                      </div>
                      <p className="text-slate-600 mb-6">
                        ¿Cancelar permanentemente la suscripción de <strong>{selectedSub.customer_name}</strong>?
                      </p>
                      <div className="flex gap-3">
                        <button
                          onClick={closeModal}
                          className="flex-1 px-4 py-2 border rounded-lg hover:bg-slate-50"
                          disabled={loading}
                        >
                          No, mantener
                        </button>
                        <button
                          onClick={() => updateSubscriptionStatus('cancel')}
                          className="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                          disabled={loading}
                        >
                          {loading ? 'Cancelando...' : 'Sí, cancelar'}
                        </button>
                      </div>
                    </>
                  )}
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    // Render
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<SubscriptionDashboard />);
  </script>
</body>
</html>
